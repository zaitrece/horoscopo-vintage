name: Horoscopo diario

on:
  workflow_dispatch:
  on:
  schedule:
    - cron: '1 22 * * *'   # 00:01 en España (22:01 UTC del día anterior)

permissions:
  contents: write           # necesario para git push

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar jq (por si no está)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Preparar base latest.json
        run: |
          mkdir -p data
          if [ ! -f data/latest.json ]; then
            cat > data/latest.json <<'EOF'
{
  "aries": {}, "taurus": {}, "gemini": {}, "cancer": {}, "leo": {}, "virgo": {},
  "libra": {}, "scorpio": {}, "sagittarius": {}, "capricorn": {}, "aquarius": {}, "pisces": {}
}
EOF
          fi

      - name: Actualizar 12 signos (reintentos y sin pisar si falla)
        shell: bash
        run: |
          set -e
          SIGNS=(aries taurus gemini cancer leo virgo libra scorpio sagittarius capricorn aquarius pisces)
          cp data/latest.json latest.tmp.json
          for s in "${SIGNS[@]}"; do
            echo "===> $s"
            ok=0
            for i in {1..4}; do
              curl -s -X POST "https://aztro.sameerkumar.website?sign=$s&day=today" \
                   -H 'Content-Length: 0' -o tmp_sign.json || true
              if grep -q '"current_date"' tmp_sign.json; then
                ok=1; break
              fi
              echo "Reintento $i para $s"; sleep 3
            done
            if [ $ok -eq 1 ]; then
              # Inserta/actualiza la clave $s dentro de latest.tmp.json
              jq --arg k "$s" --slurpfile v tmp_sign.json '.[$k] = $v[0]' latest.tmp.json > latest.out.json
              mv latest.out.json latest.tmp.json
            else
              echo "API falló para $s; conservo lo que hubiese."
            fi
            sleep 1
          done
          mv latest.tmp.json data/latest.json

      - name: Commit y push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add data/latest.json
          git commit -m "Auto-update latest.json $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "Sin cambios"
          git push
